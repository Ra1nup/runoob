# C++ ç¨‹åºå†…å­˜æ¨¡å‹æ·±åº¦è§£æ

## ğŸ“Š å†…å­˜å››åŒºç»“æ„å›¾è§£

```mermaid
graph TD
    A[ç¨‹åºå†…å­˜æ¨¡å‹] --> B[ä»£ç åŒº]
    A --> C[å…¨å±€åŒº]
    A --> D[æ ˆåŒº]
    A --> E[å †åŒº]
    E --> F[newè¿ç®—ç¬¦]
```

## 1. å†…å­˜å››åŒºæ¦‚è¿°

C++ç¨‹åºè¿è¡Œæ—¶ï¼Œå†…å­˜è¢«åˆ’åˆ†ä¸º**å››ä¸ªæ ¸å¿ƒåŒºåŸŸ**ï¼Œæ¯ä¸ªåŒºåŸŸç®¡ç†ä¸åŒç±»å‹çš„æ•°æ®ï¼š

| å†…å­˜åŒºåŸŸ | å­˜å‚¨å†…å®¹ | ç”Ÿå‘½å‘¨æœŸ | ç®¡ç†æ–¹å¼ |
|----------|----------|----------|----------|
| **ä»£ç åŒº** | äºŒè¿›åˆ¶ä»£ç  | ç¨‹åºæ•´ä¸ªè¿è¡ŒæœŸ | æ“ä½œç³»ç»Ÿç®¡ç† |
| **å…¨å±€åŒº** | å…¨å±€å˜é‡ã€é™æ€å˜é‡ã€å¸¸é‡ | ç¨‹åºæ•´ä¸ªè¿è¡ŒæœŸ | ç¼–è¯‘å™¨åˆ†é… |
| **æ ˆåŒº** | å±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•° | å‡½æ•°æ‰§è¡ŒæœŸé—´ | ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…é‡Šæ”¾ |
| **å †åŒº** | åŠ¨æ€åˆ†é…çš„å†…å­˜ | ç¨‹åºå‘˜æ§åˆ¶ | æ‰‹åŠ¨åˆ†é…é‡Šæ”¾ |

## 2. ä»£ç åŒº (Code Area)

### æ ¸å¿ƒç‰¹æ€§
- **åªè¯»å­˜å‚¨**ï¼šå­˜æ”¾CPUæ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤
- **å…±äº«ç‰¹æ€§**ï¼šç›¸åŒç¨‹åºå¤šä¸ªå®ä¾‹å…±äº«åŒä¸€ä»£ç åŒº
- **ç¡®å®šæ€§**ï¼šä»£ç åœ¨ç¨‹åºç¼–è¯‘åå³ç¡®å®š

### å­˜å‚¨å†…å®¹
1. ç¨‹åºæ‰§è¡Œçš„**äºŒè¿›åˆ¶ä»£ç **
2. **å¸¸é‡å­—ç¬¦ä¸²**ï¼ˆå¦‚"Hello World"ï¼‰
3. **constä¿®é¥°çš„å…¨å±€å¸¸é‡**

### å†…å­˜ç‰¹ç‚¹
```cpp
// ç¤ºä¾‹ï¼šä»£ç åŒºå­—ç¬¦ä¸²å…±äº«éªŒè¯
const char* str1 = "Hello";
const char* str2 = "Hello";

cout << (void*)str1 << endl; // 0x404000
cout << (void*)str2 << endl; // 0x404000 ç›¸åŒåœ°å€
```

### å…³é”®ç‚¹
- **ä¸å¯ä¿®æ”¹æ€§**ï¼šä»»ä½•ä¿®æ”¹ä»£ç åŒºçš„å°è¯•éƒ½ä¼šå¯¼è‡´æ®µé”™è¯¯
- **é«˜æ•ˆè®¿é—®**ï¼šç¨‹åºæ‰§è¡ŒæœŸé—´å§‹ç»ˆé©»ç•™å†…å­˜
- **å¤§å°å›ºå®š**ï¼šç¼–è¯‘åç¡®å®šï¼Œè¿è¡Œæ—¶ä¸å˜

## 3. å…¨å±€åŒº (Global Area)

### å­˜å‚¨å†…å®¹
| æ•°æ®ç±»å‹ | ç¤ºä¾‹ | ç”Ÿå‘½å‘¨æœŸ |
|----------|------|----------|
| å…¨å±€å˜é‡ | `int globalVar;` | æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸ |
| é™æ€å˜é‡ | `static int staticVar;` | æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸ |
| å¸¸é‡æ•°æ® | `const int constGlobal = 10;` | æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸ |
| å­—ç¬¦ä¸²å¸¸é‡ | `"Hello World"` | æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸ |

### å†…å­˜å¸ƒå±€ç¤ºä¾‹
```cpp
int globalVar = 1;         // å…¨å±€å˜é‡
const int constGlobal = 2; // å…¨å±€å¸¸é‡
static int staticVar = 3;  // é™æ€å˜é‡

int main() {
    static int localStatic = 4; // å±€éƒ¨é™æ€å˜é‡
    
    cout << "å…¨å±€å˜é‡åœ°å€: " << &globalVar << endl;
    cout << "å…¨å±€å¸¸é‡åœ°å€: " << &constGlobal << endl;
    cout << "é™æ€å˜é‡åœ°å€: " << &staticVar << endl;
    cout << "å±€éƒ¨é™æ€å˜é‡åœ°å€: " << &localStatic << endl;
    
    return 0;
}
```

### ç‰¹ç‚¹æ€»ç»“
- **åˆå§‹åŒ–**ï¼šæœªæ˜¾å¼åˆå§‹åŒ–ä¼šè¢«è‡ªåŠ¨åˆå§‹åŒ–ä¸º0
- **å¯è§æ€§**ï¼š
  - å…¨å±€å˜é‡ï¼šæ•´ä¸ªç¨‹åºå¯è§
  - é™æ€å˜é‡ï¼šæ–‡ä»¶/å‡½æ•°ä½œç”¨åŸŸå†…å¯è§
- **è®¿é—®æ•ˆç‡**ï¼šé«˜äºå †å†…å­˜ï¼Œä½äºæ ˆå†…å­˜

## 4. æ ˆåŒº (Stack Area)

### æ ¸å¿ƒæœºåˆ¶
- **è‡ªåŠ¨ç®¡ç†**ï¼šç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…é‡Šæ”¾
- **LIFOç»“æ„**ï¼šåè¿›å…ˆå‡ºï¼ˆLast In First Outï¼‰
- **å¤§å°é™åˆ¶**ï¼šé€šå¸¸è¾ƒå°ï¼ˆWindowsé»˜è®¤1MBï¼ŒLinuxé»˜è®¤8MBï¼‰

### å­˜å‚¨å†…å®¹
1. **å±€éƒ¨å˜é‡**
2. **å‡½æ•°å‚æ•°**
3. **å‡½æ•°è¿”å›åœ°å€**
4. **å¯„å­˜å™¨ä¸Šä¸‹æ–‡**

### æ ˆå¸§ç»“æ„
```cpp
void func(int param) {       // å‚æ•°paramåœ¨æ ˆåŒº
    int localVar = 10;       // å±€éƒ¨å˜é‡åœ¨æ ˆåŒº
    // ...
} // å‡½æ•°ç»“æŸè‡ªåŠ¨é‡Šæ”¾

int main() {
    int num = 5;             // å±€éƒ¨å˜é‡åœ¨æ ˆåŒº
    func(num);
    return 0;
}
```

### æ ˆåŒºç‰¹ç‚¹
- **é«˜æ•ˆè®¿é—®**ï¼šåˆ†é…é‡Šæ”¾é€Ÿåº¦å¿«
- **ç©ºé—´æœ‰é™**ï¼šå¤§å¯¹è±¡å¯èƒ½å¯¼è‡´æ ˆæº¢å‡º
- **ä½œç”¨åŸŸç»‘å®š**ï¼šå˜é‡ç”Ÿå‘½å‘¨æœŸä¸ä½œç”¨åŸŸç›¸å…³
- **ä¸å¯æ§æ€§**ï¼šç¨‹åºå‘˜æ— æ³•å¹²é¢„åˆ†é…é‡Šæ”¾è¿‡ç¨‹
- **==ä¸è¦è¿”å›å±€éƒ¨å˜é‡çš„åœ°å€==**

## 5. å †åŒº (Heap Area)

### æ ¸å¿ƒç‰¹æ€§
- **åŠ¨æ€åˆ†é…**ï¼šè¿è¡Œæ—¶æŒ‰éœ€åˆ†é…å†…å­˜
- **æ‰‹åŠ¨ç®¡ç†**ï¼šç¨‹åºå‘˜è´Ÿè´£åˆ†é…å’Œé‡Šæ”¾
- **ç©ºé—´å·¨å¤§**ï¼šç†è®ºå¯è¾¾ç³»ç»Ÿå¯ç”¨å†…å­˜ä¸Šé™
- **ç¢ç‰‡é—®é¢˜**ï¼šé¢‘ç¹åˆ†é…é‡Šæ”¾å¯èƒ½äº§ç”Ÿå†…å­˜ç¢ç‰‡

### å †åŒºæ“ä½œå‡½æ•°
| æ“ä½œ | Cè¯­è¨€ | C++ |
|------|-------|-----|
| å†…å­˜åˆ†é… | `malloc()` | `new` |
| å†…å­˜é‡Šæ”¾ | `free()` | `delete` |
| é‡æ–°åˆ†é… | `realloc()` | - |

## 6. newè¿ç®—ç¬¦è¯¦è§£

### åŸºæœ¬è¯­æ³•
```cpp
// å•ä¸ªå¯¹è±¡
ç±»å‹* æŒ‡é’ˆå˜é‡ = new ç±»å‹;          // é»˜è®¤åˆå§‹åŒ–
ç±»å‹* æŒ‡é’ˆå˜é‡ = new ç±»å‹(åˆå§‹å€¼);   // å¸¦åˆå§‹å€¼

// å¯¹è±¡æ•°ç»„
ç±»å‹* æ•°ç»„æŒ‡é’ˆ = new ç±»å‹[å…ƒç´ ä¸ªæ•°]; // åŠ¨æ€æ•°ç»„
```

### å†…å­˜åˆ†é…æµç¨‹
```mermaid
sequenceDiagram
    participant Program
    participant Heap
    Program->>Heap: newè¯·æ±‚
    Heap-->>Program: è¿”å›å†…å­˜åœ°å€
    Program->>Heap: deleteé‡Šæ”¾
```

### ä½¿ç”¨ç¤ºä¾‹
```cpp
// å•ä¸ªintåˆ†é…
int* pInt = new int(10); 
cout << *pInt; // 10
delete pInt;   // é‡Šæ”¾

// æ•°ç»„åˆ†é…
int* arr = new int[5]{1,2,3,4,5}; 
for(int i=0; i<5; i++) {
    cout << arr[i] << " ";
}
delete[] arr; // æ•°ç»„é‡Šæ”¾

// å¯¹è±¡åˆ†é…
class MyClass {
public:
    MyClass() { cout << "æ„é€ \n"; }
    ~MyClass() { cout << "ææ„\n"; }
};

MyClass* obj = new MyClass();
delete obj;
```

### new vs malloc å¯¹æ¯”

| ç‰¹æ€§ | new/delete | malloc/free |
|------|------------|-------------|
| è¯­è¨€ | C++ç‰¹æœ‰ | C/C++é€šç”¨ |
| åˆå§‹åŒ– | æ”¯æŒæ„é€ å‡½æ•° | ä¸åˆå§‹åŒ– |
| è®¡ç®—å¤§å° | è‡ªåŠ¨è®¡ç®— | éœ€æ‰‹åŠ¨è®¡ç®— |
| å¤±è´¥å¤„ç† | æŠ›å‡ºbad_alloc | è¿”å›NULL |
| ç±»å‹å®‰å…¨ | ç±»å‹å®‰å…¨ | void*éœ€å¼ºè½¬ |
| é‡è½½æ”¯æŒ | å¯é‡è½½ | ä¸å¯é‡è½½ |

### é«˜çº§ç”¨æ³•
```cpp
// å®šä½newï¼ˆåœ¨æŒ‡å®šå†…å­˜åˆ›å»ºå¯¹è±¡ï¼‰
char buffer[sizeof(MyClass)];
MyClass* p = new (buffer) MyClass();

// ä¸æŠ›å‡ºå¼‚å¸¸çš„new
int* p = new(nothrow) int[1000000000];
if(!p) cout << "åˆ†é…å¤±è´¥";

// è‡ªå®šä¹‰åˆ†é…å™¨
void* operator new(size_t size) {
    cout << "åˆ†é…" << size << "å­—èŠ‚";
    return malloc(size);
}
```

## âš ï¸ å †å†…å­˜ç®¡ç†æ³¨æ„äº‹é¡¹

### 1. å†…å­˜æ³„æ¼
```cpp
void leakMemory() {
    int* p = new int[100]; 
    // å¿˜è®°delete â†’ å†…å­˜æ³„æ¼ï¼
}
```

### 2. é‡å¤é‡Šæ”¾
```cpp
int* p = new int;
delete p;
// delete p; // é”™è¯¯ï¼é‡å¤é‡Šæ”¾
```

### 3. ä¸åŒ¹é…çš„é‡Šæ”¾
```cpp
int* single = new int;
// delete[] single; // é”™è¯¯ï¼åº”ç”¨delete

int* array = new int[10];
// delete array;    // é”™è¯¯ï¼åº”ç”¨delete[]
```

### 4. é‡æŒ‡é’ˆé—®é¢˜
```cpp
int* p = new int(5);
delete p;
// *p = 10; // å±é™©ï¼é‡æŒ‡é’ˆè®¿é—®
p = nullptr; // æ­£ç¡®åšæ³•
```

## ğŸ› ï¸ å †å†…å­˜æœ€ä½³å®è·µ

### 1. RAIIåŸåˆ™
```cpp
class SmartPointer {
    int* ptr;
public:
    explicit SmartPointer(int* p) : ptr(p) {}
    ~SmartPointer() { delete ptr; }
    int& operator*() { return *ptr; }
};

void safeUse() {
    SmartPointer sp(new int(10));
    cout << *sp; // è‡ªåŠ¨ç®¡ç†å†…å­˜
} // ç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾
```

### 2. æ™ºèƒ½æŒ‡é’ˆï¼ˆC++11+ï¼‰
```cpp
#include <memory>

// ç‹¬å æ‰€æœ‰æƒ
std::unique_ptr<int> uptr(new int(5));

// å…±äº«æ‰€æœ‰æƒ
std::shared_ptr<int> sptr1 = std::make_shared<int>(10);
std::shared_ptr<int> sptr2 = sptr1;

// å¼±å¼•ç”¨
std::weak_ptr<int> wptr = sptr1;
```

### 3. å†…å­˜æ³„æ¼æ£€æµ‹
- **å·¥å…·ä½¿ç”¨**ï¼šValgrindã€AddressSanitizer
- **ä»£ç è§„èŒƒ**ï¼š
  ```cpp
  #define _CRTDBG_MAP_ALLOC
  #include <crtdbg.h>
  
  int main() {
      _CrtSetDbgFlag(_CRTDBG_ALLOC_MEM_DF | _CRTDBG_LEAK_CHECK_DF);
      int* p = new int(10);
      // å¿˜è®°delete â†’ ç¨‹åºç»“æŸæŠ¥å‘Šæ³„æ¼
      return 0;
  }
  ```

## ğŸ” å†…å­˜é—®é¢˜è°ƒè¯•æŠ€å·§

### 1. å¸¸è§é”™è¯¯è¯†åˆ«
| é”™è¯¯ç±»å‹ | å…¸å‹è¡¨ç° | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| å†…å­˜æ³„æ¼ | å†…å­˜æŒç»­å¢é•¿ | æ£€æŸ¥new/deleteé…å¯¹ |
| é‡æŒ‡é’ˆ | éšæœºå´©æºƒ | é‡Šæ”¾åç½®ç©ºæŒ‡é’ˆ |
| è¶Šç•Œè®¿é—® | æ•°æ®æŸå | æ£€æŸ¥æ•°ç»„è¾¹ç•Œ |
| é‡å¤é‡Šæ”¾ | ç¨‹åºå´©æºƒ | ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ |
| æ ˆæº¢å‡º | Stack overflow | å‡å°‘æ ˆä½¿ç”¨ï¼Œæ”¹ç”¨å † |

### 2. è¯Šæ–­å·¥å…·
- **Windows**ï¼š
  - Visual Studioè¯Šæ–­å·¥å…·
  - CRTè°ƒè¯•åº“
- **Linux**ï¼š
  - Valgrindï¼š`valgrind --leak-check=full ./program`
  - AddressSanitizerï¼š`g++ -fsanitize=address -g program.cpp`
- **è·¨å¹³å°**ï¼š
  - Dr. Memory
  - Intel Inspector

## ğŸ“Š å†…å­˜æ¨¡å‹ç»¼åˆæ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šåŠ¨æ€çŸ©é˜µè¿ç®—
```cpp
// åˆ›å»ºåŠ¨æ€äºŒç»´æ•°ç»„
double** createMatrix(int rows, int cols) {
    double** matrix = new double*[rows];
    for (int i = 0; i < rows; i++) {
        matrix[i] = new double[cols]{0}; // åˆå§‹åŒ–ä¸º0
    }
    return matrix;
}

// é‡Šæ”¾çŸ©é˜µå†…å­˜
void freeMatrix(double** matrix, int rows) {
    for (int i = 0; i < rows; i++) {
        delete[] matrix[i]; // é‡Šæ”¾æ¯è¡Œ
    }
    delete[] matrix; // é‡Šæ”¾æŒ‡é’ˆæ•°ç»„
}

// çŸ©é˜µä¹˜æ³•
void matrixMultiply(double** a, double** b, double** result, 
                   int m, int n, int p) {
    for (int i = 0; i < m; i++) {
        for (int j = 0; j < p; j++) {
            result[i][j] = 0;
            for (int k = 0; k < n; k++) {
                result[i][j] += a[i][k] * b[k][j];
            }
        }
    }
}

int main() {
    const int M = 2, N = 3, P = 2;
    
    // åŠ¨æ€åˆ›å»ºçŸ©é˜µ
    double** matA = createMatrix(M, N);
    double** matB = createMatrix(N, P);
    double** matC = createMatrix(M, P);
    
    // åˆå§‹åŒ–æ•°æ®...
    
    // çŸ©é˜µè¿ç®—
    matrixMultiply(matA, matB, matC, M, N, P);
    
    // é‡Šæ”¾å†…å­˜
    freeMatrix(matA, M);
    freeMatrix(matB, N);
    freeMatrix(matC, M);
    
    return 0;
}
```

### æ¡ˆä¾‹2ï¼šæ™ºèƒ½æŒ‡é’ˆç®¡ç†èµ„æº
```cpp
#include <memory>
#include <vector>

class Resource {
public:
    Resource() { std::cout << "èµ„æºè·å–\n"; }
    ~Resource() { std::cout << "èµ„æºé‡Šæ”¾\n"; }
    void use() { std::cout << "ä½¿ç”¨èµ„æº\n"; }
};

void process() {
    // ç‹¬å æŒ‡é’ˆ
    auto res1 = std::make_unique<Resource>();
    res1->use();
    
    // å…±äº«æŒ‡é’ˆ
    std::shared_ptr<Resource> res2 = std::make_shared<Resource>();
    {
        std::shared_ptr<Resource> res3 = res2;
        res3->use(); // å¼•ç”¨è®¡æ•°=2
    } // res3ææ„ï¼Œå¼•ç”¨è®¡æ•°=1
    
    res2->use();
    
    // èµ„æºè½¬ç§»
    std::unique_ptr<Resource> res4 = std::move(res1);
    if(!res1) std::cout << "res1å·²è½¬ç§»\n";
} // è‡ªåŠ¨é‡Šæ”¾æ‰€æœ‰èµ„æº

int main() {
    process();
    return 0;
}
/* è¾“å‡º:
èµ„æºè·å–
ä½¿ç”¨èµ„æº
èµ„æºè·å–
ä½¿ç”¨èµ„æº
ä½¿ç”¨èµ„æº
res1å·²è½¬ç§»
èµ„æºé‡Šæ”¾
èµ„æºé‡Šæ”¾
*/
```

## ğŸ’ å†…å­˜ç®¡ç†é»„é‡‘æ³•åˆ™

1. **é…å¯¹åŸåˆ™**ï¼šæ¯ä¸ª`new`å¿…é¡»æœ‰å¯¹åº”çš„`delete`ï¼Œæ¯ä¸ª`new[]`å¿…é¡»æœ‰å¯¹åº”çš„`delete[]`
2. **æ‰€æœ‰æƒæ¸…æ™°**ï¼šæ˜ç¡®æ¯ä¸ªåŠ¨æ€å†…å­˜çš„æ‰€æœ‰æƒè´£ä»»
3. **ä¼˜å…ˆæ ˆåˆ†é…**ï¼šå°å¯¹è±¡å’Œå±€éƒ¨å˜é‡ä¼˜å…ˆä½¿ç”¨æ ˆå†…å­˜
4. **æ™ºèƒ½æŒ‡é’ˆä¼˜å…ˆ**ï¼šä½¿ç”¨`unique_ptr`ã€`shared_ptr`ä»£æ›¿è£¸æŒ‡é’ˆ
5. **é¿å…è£¸new**ï¼šå°è£…èµ„æºç®¡ç†åœ¨RAIIå¯¹è±¡ä¸­
6. **è¾¹ç•Œæ£€æŸ¥**ï¼šåŠ¨æ€æ•°ç»„è®¿é—®å¿…é¡»æ£€æŸ¥ç´¢å¼•
7. **åˆå§‹åŒ–åŸåˆ™**ï¼šåŠ¨æ€å†…å­˜åˆ†é…åç«‹å³åˆå§‹åŒ–
8. **NULLæ£€æŸ¥**ï¼šä½¿ç”¨æŒ‡é’ˆå‰æ£€æŸ¥æ˜¯å¦ä¸º`nullptr`

```cpp
// ç°ä»£C++å†…å­˜ç®¡ç†å…¸èŒƒ
auto data = std::make_unique<int[]>(100); // è‡ªåŠ¨ç®¡ç†æ•°ç»„
std::vector<double> values;               // åŠ¨æ€æ•°ç»„é¦–é€‰
std::string text = "Safe memory";         // å­—ç¬¦ä¸²ç®¡ç†
```